<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Auxilium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://unpkg.com/@capacitor/core@latest/dist/capacitor.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
            fontFamily: { sans: ["Inter", "sans-serif"] },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #3F0B4D;
        color: #1e293b;
        transition: all 0.3s ease;
      }
      .input-field {
        transition: all 0.3s ease;
        background-color: #f8fafc;
      }
      .input-field:focus {
        border-color: #E51B85;
        box-shadow: 0 0 0 3px rgba(176, 1, 89, 0.3);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }

      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .popup-overlay.active {
        opacity: 1;
        pointer-events: all;
      }
      .popup-content {
        background-color: white;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 400px;
        transform: translateY(20px);
        transition: transform 0.3s ease;
        max-height: 80vh;
        overflow-y: auto;
      }
      .popup-overlay.active .popup-content {
        transform: translateY(0);
      }
      .recovery-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: white;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 2rem;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .recovery-screen.active {
        opacity: 1;
        pointer-events: all;
      }

      .logo {
        height: 35px;
        transition: all 0.3s ease;
      }
      .close-btn {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.1);
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .close-btn:hover {
        background-color: rgba(0, 0, 0, 0.2);
      }

      @keyframes slideUp {
        0% {
          transform: translateY(100%);
          opacity: 0;
        }
        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .animate-slide-up {
        animation: slideUp 0.3s ease-out forwards;
      }
      @keyframes slideDownOut {
        0% {
          transform: translateY(0);
          opacity: 1;
        }
        100% {
          transform: translateY(100%);
          opacity: 0;
        }
      }
      .animate-slide-down {
        animation: slideDownOut 0.3s ease-in forwards;
      }
      @keyframes toastDown {
        0% {
          transform: translateY(-50%);
          opacity: 0;
        }
        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes toastUp {
        0% {
          transform: translateY(0);
          opacity: 0;
        }
        100% {
          transform: translateY(-50%);
          opacity: 1;
        }
      }
      .no-scroll {
        overflow: hidden;
      }

      .input-clean {
        background-color: #f8fafc;
        border-color: #e5e7eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .input-icon {
        color: #9ca3af;
      }

      .fingerprint-btn {
        transition: all 0.3s ease;
      }
      .fingerprint-btn:hover {
        transform: scale(1.05);
        color: #0ea5e9;
      }

      .connecting-animation {
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      #toastContainer {
        pointer-events: none;
      }
      #toastContainer > * {
        pointer-events: auto;
      }
    </style>
  </head>

  <body class="min-h-screen">
    <input
      type="text"
      tabindex="-1"
      aria-hidden="true"
      autocomplete="username"
      style="
        position: absolute;
        left: -9999px;
        width: 1px;
        height: 1px;
        opacity: 0;
      "
    />
    <input
      type="password"
      tabindex="-1"
      aria-hidden="true"
      autocomplete="current-password"
      style="
        position: absolute;
        left: -9999px;
        width: 1px;
        height: 1px;
        opacity: 0;
      "
    />

    <main
      class="min-h-screen flex flex-col justify-center items-center px-4 py-6 max-w-md mx-auto bg-[#3F0B4D]"
    >
      <div class="flex justify-center mb-8">
        <img
          id="logo-clara"
          class="logo"
          src="../assets/images/logos/Logo.png"
          alt="Logo Auxilium"
        />
      </div>

      <div class="w-full max-w-sm animate-fade-in" id="loginForm">
        <div class="flex flex-col items-center">
          <h1 class="text-3xl text-center text-white leading-5 font-bold">
            Entre na sua conta
          </h1>
        </div>

        <div class="text-center pt-2 mb-8 mt-2">
            <a
              href="cadastro.html"
              class="text-sm text-white font-semibold"
            >
              Ainda não tem uma conta? <span class="text-[#E51A85]">Cadastre-se</span>
            </a>
          </div>

        <form id="login-form" class="space-y-4" autocomplete="off" novalidate>
          <div>
            <label for="login-email" class="sr-only">Email Institucional</label>
            <div class="relative">
              <span
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i class="fas fa-envelope input-icon"></i>
              </span>
              <input
                type="email"
                id="login-email"
                name="login-email"
                autocomplete="off"
                autocapitalize="none"
                autocorrect="off"
                spellcheck="false"
                placeholder="seu@email.com"
                class="input-field input-clean h-11 pl-10 w-full px-4 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-300"
                required
              />
            </div>
          </div>

          <div>
            <div class="relative">
              <span
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i class="fas fa-lock input-icon"></i>
              </span>
              <input
                type="password"
                id="login-password"
                autocomplete="off"
                placeholder="••••••••"
                class="input-field input-clean h-11 pl-10 w-full px-4 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-300"
                required
              />
              <button
                type="button"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-500"
                id="togglePassword"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="text-center">
              <a
                href="#"
                class="text-sm text-white hover:text-primary-800 font-light underline"
                id="forgotPasswordLink"
                >Esqueceu a senha?</a
              >
            </div>

          <button
            type="submit"
            id="btn-login"
            class="w-full h-14 flex justify-center items-center rounded-lg text-white font-medium shadow-sm transition-all active:scale-[.99] bg-gradient-to-b from-[#E83593] to-[#E51B85]"
          >
            <i class="fas fa-right-to-bracket mr-2 text-[14px]"></i>
            Entrar
          </button>

          

          <div class="flex justify-center pt-4">
            <button
              type="button"
              class="fingerprint-btn text-[28px] text-gray-400 hover:text-primary-500"
              id="fingerprintBtn"
            >
              <i class="fas fa-fingerprint"></i>
            </button>
          </div>
        </form>
      </div>

      <div id="offlineModal" class="fixed inset-0 z-50 hidden"></div>
    </main>

    <div class="recovery-screen" id="recoveryScreen">
      <button class="close-btn" id="closeRecoveryScreen">
        <i class="fas fa-times"></i>
      </button>

      <div class="flex justify-center mb-8">
        <img
          src="../assets/images/logos/logo_preta.png"
          alt="Auxilium"
          class="logo"
        />
      </div>

      <div class="w-full max-w-sm">
        <h1 class="text-2xl font-bold text-center mb-2 text-gray-800">
          Recuperar senha
        </h1>
        <p class="text-center text-gray-500 mb-6">
          Digite seu e-mail para receber as instruções de recuperação
        </p>

        <form id="recoveryForm" class="space-y-4">
          <div>
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i class="fas fa-envelope text-gray-400"></i>
              </div>
              <input
                type="email"
                id="recoveryEmail"
                class="input-field input-clean h-11 pl-10 w-full px-4 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-300"
                placeholder="Seu e-mail cadastrado"
                required
              />
            </div>
          </div>

          <button
            type="submit"
            class="w-full h-11 flex justify-center items-center rounded-lg text-white font-medium shadow-sm btn-gradient transition-all active:scale-[.99]"
          >
            Enviar instruções
          </button>

          <div class="text-center mt-4">
            <a
              href="#"
              class="text-sm text-primary-700 hover:text-primary-800 font-medium"
              id="backToLogin"
              >Voltar para o login</a
            >
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import Utils from "../utils.js";
      import * as loginModel from "../models/loginModel.js";
      (function fixToasts() {
        if (!window.Utils || typeof Utils.showMessageToast !== "function")
          return;
        const orig = Utils.showMessageToast.bind(Utils);
        let running = false;
        const queue = [];
        function showOne({ type, title, message, opts }) {
          return new Promise((resolve) => {
            const dur = Math.max(1500, Number(opts?.duration) || 3200);
            let userClosed = false;
            let el = null;
            orig(type, title, message, opts || {});
            const container =
              document.getElementById("toastContainer") || document.body;
            el = container.lastElementChild;
            if (el) {
              el.style.pointerEvents = "auto";
              el.addEventListener(
                "click",
                () => {
                  userClosed = true;
                  setTimeout(() => {
                    try {
                      el?.remove();
                    } catch {}
                    resolve();
                  }, 0);
                },
                { once: true }
              );
            }
            const started = performance.now();
            (function tick() {
              const elapsed = performance.now() - started;
              if (userClosed) return;
              if (elapsed >= dur) {
                try {
                  el?.remove();
                } catch {}
                resolve();
                return;
              }
              if (!el || !el.isConnected) {
                resolve();
                return;
              }
              requestAnimationFrame(tick);
            })();
          });
        }
        async function pump() {
          if (running) return;
          const item = queue.shift();
          if (!item) return;
          running = true;
          try {
            await showOne(item);
          } finally {
            running = false;
            pump();
          }
        }
        Utils.showMessageToast = (type, title, message, opts = {}) => {
          queue.push({ type, title, message, opts });
          pump();
        };
      })();
      const BUILD_VERSION = "1.0.0";

      function normalizeVersion(v) {
        return String(v || "")
          .trim()
          .replace(/^v/i, "")
          .replace(/[^\d.]/g, "");
      }

      function semverCompare(a, b) {
        const pa = normalizeVersion(a)
          .split(".")
          .map((n) => parseInt(n || "0", 10));
        const pb = normalizeVersion(b)
          .split(".")
          .map((n) => parseInt(n || "0", 10));
        const len = Math.max(pa.length, pb.length);
        for (let i = 0; i < len; i++) {
          const da = pa[i] || 0,
            db = pb[i] || 0;
          if (da < db) return -1;
          if (da > db) return 1;
        }
        return 0;
      }

      function runAfterDOM(fn) {
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", fn, { once: true });
        } else {
          fn();
        }
      }

      async function clearWebCachesOnce() {
        try {
          if ("caches" in window) {
            const names = await caches.keys();
            await Promise.all(names.map((n) => caches.delete(n)));
          }
        } catch (e) {
          console.warn("[Versão] Web: falha limpando caches", e);
        }
      }

      function isNativeCapacitor() {
        const Cap = window.Capacitor;
        return !!(
          Cap &&
          (Cap.isNativePlatform?.() ||
            (Cap.getPlatform && Cap.getPlatform() !== "web"))
        );
      }

      async function getVersionApp() {
        try {
          const res = await fetch("https://sua-api.com/v1/versao-app");
          const data = await res.json();
          const serverVersion = data.version;
          const localVersion =
            localStorage.getItem("app_version") || BUILD_VERSION;

          if (semverCompare(serverVersion, localVersion) > 0) {
            Utils.showMessageToast(
              "info",
              "Atualização Disponível",
              "Uma nova versão do app está disponível."
            );

            if (isNativeCapacitor()) {
              const { Device, WebViewCache, ClearCache } = Capacitor.Plugins;
              const { platform } = await Device.getInfo();
              if (platform === "android") {
                await WebViewCache.clearCache();
              } else {
                await ClearCache.clear();
              }
              localStorage.setItem("app_version", serverVersion);
              window.location.reload();
            }
          }
        } catch (err) {
          console.error("Erro ao obter versão:", err);
        }
      }
      function getNB() {
        return window.Capacitor?.Plugins?.NativeBiometric || null;
      }
      function isTokenLikelyJWT(token) {
        return (
          typeof token === "string" &&
          token.split(".").length === 3 &&
          token.length > 60
        );
      }
      function clearAuth() {
        sessionStorage.removeItem("authToken");
      }
      document.addEventListener("DOMContentLoaded", async function () {
        const NativeBiometric = getNB();
        const fingerprintBtn = document.getElementById("fingerprintBtn");
        const loginForm = document.getElementById("login-form");
        const togglePassword = document.getElementById("togglePassword");
        const passwordInput = document.getElementById("login-password");
        const forgotPasswordLink =
          document.getElementById("forgotPasswordLink");
        const recoveryScreen = document.getElementById("recoveryScreen");
        const closeRecoveryScreen = document.getElementById(
          "closeRecoveryScreen"
        );
        const backToLogin = document.getElementById("backToLogin");
        const recoveryForm = document.getElementById("recoveryForm");

        clearAuth();
        togglePassword?.addEventListener("click", () => {
          const type = passwordInput.type === "password" ? "text" : "password";
          passwordInput.type = type;
          togglePassword.innerHTML =
            type === "password"
              ? '<i class="fas fa-eye"></i>'
              : '<i class="fas fa-eye-slash"></i>';
        });
        const showRecovery = (e) => {
          e.preventDefault();
          recoveryScreen.classList.add("active");
        };
        const hideRecovery = (e) => {
          e.preventDefault();
          recoveryScreen.classList.remove("active");
        };
        forgotPasswordLink?.addEventListener("click", showRecovery);
        closeRecoveryScreen?.addEventListener("click", hideRecovery);
        backToLogin?.addEventListener("click", hideRecovery);

        recoveryForm?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("recoveryEmail").value;
          if (!email) {
            Utils.showMessageToast(
              "warning",
              "Campo vazio",
              "Digite seu email."
            );
            return;
          }

          const { error } = await loginModel.resetarSenha(email);

          if (error) {
            Utils.showMessageToast(
              "error",
              "Erro",
              "Não foi possível enviar o email de recuperação."
            );
          } else {
            Utils.showMessageToast(
              "success",
              "Verifique seu email",
              "Se a conta existir, enviamos um link de recuperação."
            );
          }
          hideRecovery(e);
        });

        if (!NativeBiometric) {
          fingerprintBtn.style.display = "none";
        }

        let isFingerprintProcessing = false;
        fingerprintBtn?.addEventListener("click", async () => {
          if (isFingerprintProcessing) return;
          isFingerprintProcessing = true;

          try {
            const avail = await NativeBiometric.isAvailable();
            if (!avail.biometryType) {
              Utils.showMessageToast(
                "warning",
                "Biometria não disponível",
                "Seu dispositivo não suporta ou não configurou a biometria."
              );
              return;
            }

            await NativeBiometric.verifyIdentity({
              reason: "Login no Auxilium",
              title: "Autentique-se",
            });

            Utils.showMessageToast(
              "info",
              "Biometria",
              "TODO: Lógica de login por biometria"
            );
          } catch (err) {
            console.warn("[Fingerprint] Erro:", err);
            Utils.showMessageToast(
              "error",
              "Falha na biometria",
              "Autenticação cancelada ou falhou."
            );
          } finally {
            setTimeout(() => {
              isFingerprintProcessing = false;
            }, 1000);
          }
        });

        loginForm?.addEventListener("submit", async function (e) {
          e.preventDefault();

          const email = document.getElementById("login-email").value.trim();
          const password = document
            .getElementById("login-password")
            .value.trim();

          if (!email || !password) {
            Utils.showMessageToast(
              "warning",
              "Campos vazios",
              "Por favor, preencha seu email e senha."
            );
            return;
          }

          const btn = this.querySelector('button[type="submit"]');
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i> Entrando...';
          btn.disabled = true;

         try {
            const { data, error } = await loginModel.fazerLogin(email, password);
            
            if (error) throw new Error(error.message);

            const usuario = data.usuario;
            localStorage.setItem('user_tipo', usuario.id_tipo);
            localStorage.setItem('user_nome', usuario.nome_completo);
            localStorage.setItem('user_id', data.user.id);

            Utils.showMessageToast("success", "Login realizado!", `Olá! Redirecionando...`, { duration: 2000 });

             setTimeout(() => {
              window.location.href = "/";
            }, 1500);
          } catch (err) {
            clearAuth();
            console.error(err);
            let userMsg = "Erro inesperado. Tente novamente.";
            if (err.message.includes("aguardando aprovação")) {
            userMsg = err.message;
          } 
          
          else if (
              err.message.includes("network") ||
              err.message.includes("fetch")
            ) {
              userMsg = "Falha de conexão. Verifique sua internet.";
            }
            Utils.showMessageToast("error", "Falha no login", userMsg);
          } finally {
            btn.innerHTML =
              '<i class="fas fa-right-to-bracket mr-2 text-[14px]"></i> Entrar';
            btn.disabled = false;
          }
        });

        runAfterDOM(getVersionApp);
      });
    </script>

    <div
      id="toastContainer"
      class="fixed bottom-6 left-0 right-0 z-[3000] flex justify-center px-4 pointer-events-none"
    ></div>
  </body>
</html>
